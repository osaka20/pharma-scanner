<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pharma Scanner</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; color: #333; }
    [dir="rtl"] { text-align: right; }
    [dir="rtl"] .navbar-menu { flex-direction: row-reverse; }
    .container { max-width: 1200px; margin: 0 auto; background: white; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2); }
    .navbar { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1.5rem 2rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
    .navbar h1 { font-size: 1.8rem; }
    .navbar-menu { display: flex; gap: 2rem; flex: 1; justify-content: center; flex-wrap: wrap; }
    .nav-btn { background: rgba(255, 255, 255, 0.1); color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; font-weight: 500; transition: all 0.3s; }
    .nav-btn:hover, .nav-btn.active { background: rgba(255, 255, 255, 0.2); }
    .language-select { background: rgba(255, 255, 255, 0.1); color: white; border: 1px solid rgba(255, 255, 255, 0.3); padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; }
    .language-select option { background: #667eea; color: white; }
    .content { padding: 2rem; }
    .page { display: none; }
    .page.active { display: block; }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 2rem; margin-bottom: 2rem; }
    .stat-card { background: white; border: 1px solid #eee; border-radius: 8px; padding: 2rem; text-align: center; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05); }
    .stat-label { color: #666; font-size: 0.9rem; margin-bottom: 0.5rem; }
    .stat-value { font-size: 2rem; font-weight: bold; color: #667eea; }
    .btn { padding: 0.75rem 1.5rem; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.3s; }
    .btn-primary { background: #667eea; color: white; }
    .btn-primary:hover { background: #5568d3; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4); }
    .btn-secondary { background: #e0e0e0; color: #333; }
    .btn-danger { background: #ef5350; color: white; }
    .btn-success { background: #66bb6a; color: white; }
    .btn-warning { background: #ffb74d; color: white; }
    .sale-btn { padding: 0.5rem 1rem; background: #66bb6a; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; }
    .sale-btn:hover { background: #57a35b; }
    .sale-btn:disabled { background: #ccc; cursor: not-allowed; }
    .undo-btn { padding: 0.5rem 1rem; background: #ffb74d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; }
    .undo-btn:hover { background: #ff9800; }
    .undo-btn:disabled { background: #ccc; cursor: not-allowed; }
    .form-group { margin-bottom: 1.5rem; }
    .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
    .form-group input, .form-group textarea { width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; font-family: inherit; }
    .form-group input:focus, .form-group textarea:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1); }
    .table-container { overflow-x: auto; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05); }
    table { width: 100%; border-collapse: collapse; }
    th { background: #f5f5f5; padding: 1rem; text-align: left; font-weight: 600; border-bottom: 2px solid #ddd; }
    [dir="rtl"] th { text-align: right; }
    td { padding: 1rem; border-bottom: 1px solid #eee; text-align: left; }
    [dir="rtl"] td { text-align: right; }
    tbody tr:hover { background: #f9f9f9; }
    .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 1000; align-items: center; justify-content: center; }
    .modal.active { display: flex; }
    .modal-content { background: white; border-radius: 8px; padding: 2rem; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto; }
    .modal-header { font-size: 1.5rem; margin-bottom: 1.5rem; font-weight: 600; }
    .modal-footer { display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem; }
    .search-box { margin-bottom: 2rem; }
    .search-box input { width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
    .alert { padding: 1rem; border-radius: 4px; margin-bottom: 1rem; display: none; }
    .alert.show { display: block; }
    .alert-success { background: #e8f5e9; border: 1px solid #66bb6a; color: #2e7d32; }
    .alert-error { background: #ffebee; border: 1px solid #ef5350; color: #c62828; }
    .grid-2 { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
    .margin-negative { color: #ef5350; font-weight: bold; }
    h2 { margin-bottom: 1.5rem; color: #333; }
    h3 { margin-bottom: 1rem; color: #555; }
    .actions { display: flex; gap: 0.5rem; flex-wrap: wrap; }
    .actions .btn { padding: 0.5rem 1rem; font-size: 12px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="navbar">
      <h1 data-translate="appTitle">Pharma Scanner</h1>
      <div class="navbar-menu">
        <button class="nav-btn active" data-translate="dashboard" onclick="changePage('dashboard', this)">Dashboard</button>
        <button class="nav-btn" data-translate="products" onclick="changePage('products', this)">Products</button>
        <button class="nav-btn" data-translate="history" onclick="changePage('history', this)">History</button>
        <button class="nav-btn" data-translate="backup" onclick="changePage('export', this)">Backup</button>
      </div>
      <select class="language-select" id="langSelect" onchange="changeLanguage()">
        <option value="en">English</option>
        <option value="ar">العربية</option>
      </select>
    </div>

    <div class="content">
      <div id="alert" class="alert"></div>

      <div id="dashboard" class="page active">
        <h2 data-translate="dashboardTitle">Dashboard</h2>
        <div class="stats-grid">
          <div class="stat-card"><div class="stat-label" data-translate="totalProducts">Total Products</div><div class="stat-value" id="totalProducts">0</div></div>
          <div class="stat-card"><div class="stat-label" data-translate="stockValue">Stock Value</div><div class="stat-value" id="totalValue">0€</div></div>
          <div class="stat-card" style="display:flex; flex-direction:column; gap:0.5rem; align-items:center;">
            <div class="stat-label" data-translate="marginRealized">Margin Realized</div>
            <div class="stat-value" id="totalMargin">0€</div>
            <button class="btn btn-warning" style="padding:0.4rem 0.75rem; font-size:12px;" onclick="resetMargin()" data-translate="resetMargin">Reset Margin</button>
          </div>
        </div>
        <h3 data-translate="recentProducts">Recently Added Products</h3>
        <div class="table-container">
          <table><thead><tr><th data-translate="name">Name</th><th data-translate="brand">Brand</th><th data-translate="salePrice">Sale Price</th><th data-translate="margin">Margin</th><th data-translate="quantity">Quantity</th></tr></thead>
          <tbody id="recentProducts"><tr><td colspan="5" style="text-align: center; color: #999;" data-translate="noProducts">No products</td></tr></tbody></table>
        </div>
      </div>

      <div id="products" class="page">
        <h2 data-translate="productsTitle">Product Catalog</h2>
        <div style="margin-bottom: 1rem;"><button class="btn btn-primary" onclick="openAddForm()" data-translate="addProduct">Add Product</button></div>
        <div class="search-box"><input type="text" id="searchInput" onkeyup="filterProducts()" data-translate-placeholder="searchPlaceholder" placeholder="Search..."></div>
        <div class="table-container">
          <table><thead><tr><th data-translate="name">Name</th><th data-translate="brand">Brand</th><th data-translate="purchasePrice">Purchase Price</th><th data-translate="salePrice">Sale Price</th><th data-translate="margin">Margin</th><th data-translate="quantity">Quantity</th><th data-translate="actions">Actions</th></tr></thead>
          <tbody id="productsList"><tr><td colspan="7" style="text-align: center; color: #999;" data-translate="noProducts">No products</td></tr></tbody></table>
        </div>
      </div>

      <div id="history" class="page">
        <div style="display: flex; justify-content: space-between; align-items: center; gap: 1rem; flex-wrap: wrap;">
          <h2 data-translate="historyTitle">Sales History</h2>
          <div style="display:flex; gap:0.5rem; flex-wrap:wrap; align-items:center;">
            <input type="date" id="historyStart" style="padding:0.4rem; border:1px solid #ddd; border-radius:4px;">
            <input type="date" id="historyEnd" style="padding:0.4rem; border:1px solid #ddd; border-radius:4px;">
            <input type="text" id="historySearch" data-translate-placeholder="searchHistory" placeholder="Filter..." style="padding:0.4rem; border:1px solid #ddd; border-radius:4px;">
            <button class="btn btn-primary" onclick="applyHistoryFilters()" data-translate="applyFilters">Filter</button>
            <button class="btn btn-secondary" onclick="clearHistoryFilters()" data-translate="clearFilters">Clear</button>
            <button class="btn btn-success" onclick="exportHistoryPDF()" data-translate="exportPdf">Export PDF</button>
          </div>
        </div>
        <div class="table-container" style="margin-top: 1rem;">
          <table>
            <thead>
              <tr>
                <th data-translate="saleDate">Date</th>
                <th data-translate="saleProduct">Product</th>
                <th data-translate="saleMargin">Margin</th>
                <th data-translate="saleQuantity">Quantity</th>
                <th data-translate="saleType">Type</th>
              </tr>
            </thead>
            <tbody id="historyList"><tr><td colspan="5" style="text-align: center; color: #999;" data-translate="noSales">No sales yet</td></tr></tbody>
          </table>
        </div>
      </div>

      <div id="export" class="page">
        <h2 data-translate="backupTitle">Backup & Restore</h2>
        <div class="grid-2">
          <div style="background: #f9f9f9; padding: 2rem; border-radius: 8px; text-align: center; display:flex; flex-direction:column; gap:0.5rem;">
            <h3 data-translate="exportTitle">Export</h3><p style="margin-bottom: 0.5rem; color: #666;" data-translate="exportDesc">Download JSON backup</p>
            <button class="btn btn-success" onclick="exportData()" data-translate="exportBtn">Export to JSON</button>
            <div style="font-size:12px; color:#666;">Format compact (.json)</div>
          </div>
          <div style="background: #f9f9f9; padding: 2rem; border-radius: 8px; text-align: center; display:flex; flex-direction:column; gap:0.5rem;">
            <h3 data-translate="importTitle">Import</h3><p style="margin-bottom: 0.5rem; color: #666;" data-translate="importDesc">Restore previous backup</p>
            <input type="file" id="importFile" accept=".json" style="display: none;" onchange="handleImport()">
            <button class="btn btn-primary" onclick="document.getElementById('importFile').click()" data-translate="importBtn">Import File</button>
          </div>
        </div>
        <div style="margin-top:1.5rem; background:#f5f5f5; padding:1rem; border-radius:8px; display:flex; flex-wrap:wrap; gap:0.5rem; align-items:center;">
          <div style="font-weight:600;" data-translate="fileStorage">Stockage fichier local</div>
          <button class="btn btn-primary" onclick="selectDataFile()" data-translate="selectFile">Choisir un fichier</button>
          <button class="btn btn-secondary" onclick="createDataFile()" data-translate="createFile">Créer un fichier</button>
          <div id="fileStatus" style="font-size:12px; color:#555;">-</div>
        </div>
      </div>
    </div>
  </div>

  <div id="formModal" class="modal">
    <div class="modal-content">
      <div class="modal-header" id="formTitle" data-translate="addProductTitle">Add Product</div>
      <form id="productForm" onsubmit="saveProduct(event)">
        <div class="form-group"><label data-translate="productName">Product Name *</label><input type="text" id="formName" required></div>
        <div class="form-group"><label data-translate="brandName">Brand *</label><input type="text" id="formBrand" required></div>
        <div class="form-group"><label data-translate="productCode">Product Code</label><input type="text" id="formCode"></div>
        <div class="form-group"><label data-translate="purchasePrice">Purchase Price</label><input type="number" id="formPurchasePrice" step="0.01" min="0" onchange="calculateMargin()"></div>
        <div class="form-group"><label data-translate="salePrice">Sale Price</label><input type="number" id="formSalePrice" step="0.01" min="0" onchange="calculateMargin()"></div>
        <div class="form-group"><label data-translate="marginCalculated">Margin (Calculated)</label><input type="number" id="formMargin" step="0.01" readonly style="background: #f5f5f5;"></div>
        <div class="form-group"><label data-translate="stockQuantity">Stock Quantity</label><input type="number" id="formQuantity" step="1" min="0" value="0"></div>
        <div class="form-group"><label data-translate="notes">Notes</label><textarea id="formNotes" rows="3"></textarea></div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeForm()" data-translate="cancel">Cancel</button>
          <button type="submit" class="btn btn-primary" data-translate="save">Save</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    let products = [];
    let sales = [];
    let currentEditId = null;
    let language = localStorage.getItem('lang') || 'en';
    let marginOffset = parseFloat(localStorage.getItem('pharmaMarginOffset') || 0);
    let dirHandle = null;
    let useFileStore = false;

    const translations = {
      en: {
        appTitle: 'Pharma Scanner',
        dashboard: 'Dashboard',
        products: 'Products',
        backup: 'Backup',
        dashboardTitle: 'Dashboard',
        totalProducts: 'Total Products',
        stockValue: 'Stock Value',
        marginRealized: 'Margin Realized',
        history: 'History',
        saleType: 'Type',
        sale: 'Sale',
        undoType: 'Undo',
        recentProducts: 'Recently Added Products',
        productsTitle: 'Product Catalog',
        addProduct: 'Add Product',
        searchPlaceholder: 'Search by name, brand or code...',
        name: 'Name',
        brand: 'Brand',
        purchasePrice: 'Purchase Price',
        salePrice: 'Sale Price',
        margin: 'Margin',
        quantity: 'Quantity',
        actions: 'Actions',
        historyTitle: 'Sales History',
        resetMargin: 'Reset Margin',
        saleDate: 'Date',
        saleProduct: 'Product',
        saleMargin: 'Margin',
        saleQuantity: 'Quantity',
        sell: 'Sell',
        undo: 'Undo',
        edit: 'Edit',
        delete: 'Delete',
        backupTitle: 'Backup & Restore',
        exportTitle: 'Export',
        exportDesc: 'Download JSON backup',
        exportBtn: 'Export to JSON',
        fileStorage: 'Local file storage',
        selectFile: 'Choose file',
        createFile: 'Create file',
        exportPdf: 'Export PDF',
        importTitle: 'Import',
        importDesc: 'Restore previous backup',
        importBtn: 'Import File',
        applyFilters: 'Filter',
        clearFilters: 'Clear',
        searchHistory: 'Filter by product or type...',
        addProductTitle: 'Add Product',
        editProductTitle: 'Edit Product',
        productName: 'Product Name *',
        brandName: 'Brand *',
        productCode: 'Product Code',
        marginCalculated: 'Margin (Calculated)',
        stockQuantity: 'Stock Quantity',
        notes: 'Notes',
        save: 'Save',
        cancel: 'Cancel',
        noProducts: 'No products',
        noSales: 'No sales yet',
        saleSuccess: 'Sale recorded! Margin: ',
        undoSuccess: 'Sale cancelled!',
        saveSuccess: 'Product saved successfully!',
        deleteSuccess: 'Product deleted successfully!',
        exportSuccess: 'Data exported successfully!',
        importSuccess: 'Data imported successfully!',
        deleteConfirm: 'Are you sure you want to delete this product?',
        importConfirm: 'This will replace all current products. Continue?',
        stockError: 'Insufficient stock!',
        noSaleToUndo: 'No recent sale to undo for this product!',
        resetConfirm: 'Reset realized margin to zero? History will stay.',
        resetSuccess: 'Margin reset to zero.'
      },
      ar: {
        appTitle: 'Pharma Scanner',
        dashboard: 'لوحة المعلومات',
        products: 'المنتجات',
        backup: 'النسخ الاحتياطي',
        dashboardTitle: 'لوحة المعلومات',
        totalProducts: 'إجمالي المنتجات',
        stockValue: 'قيمة المخزون',
        marginRealized: 'الهامش المحقق',
        history: 'السجل',
        saleType: 'النوع',
        sale: 'بيع',
        undoType: 'تراجع',
        recentProducts: 'المنتجات المضافة مؤخراً',
        productsTitle: 'كتالوج المنتجات',
        addProduct: 'إضافة منتج',
        searchPlaceholder: 'البحث بالاسم أو العلامة التجارية أو الرمز...',
        name: 'الاسم',
        brand: 'العلامة التجارية',
        purchasePrice: 'سعر الشراء',
        salePrice: 'سعر البيع',
        margin: 'الهامش',
        quantity: 'الكمية',
        actions: 'الإجراءات',
        historyTitle: 'سجل المبيعات',
        resetMargin: 'تصفير الهامش',
        saleDate: 'التاريخ',
        saleProduct: 'المنتج',
        saleMargin: 'الهامش',
        saleQuantity: 'الكمية',
        sell: 'بيع',
        undo: 'تراجع',
        edit: 'تعديل',
        delete: 'حذف',
        backupTitle: 'النسخ الاحتياطي والاستعادة',
        exportTitle: 'تصدير',
        exportDesc: 'تنزيل نسخة احتياطية JSON',
        exportBtn: 'تصدير إلى JSON',
        fileStorage: 'تخزين محلي في ملف',
        selectFile: 'اختر ملفاً',
        createFile: 'أنشئ ملفاً',
        exportPdf: 'تصدير PDF',
        importTitle: 'استيراد',
        importDesc: 'استعادة نسخة احتياطية سابقة',
        importBtn: 'استيراد ملف',
        applyFilters: 'تطبيق الفلاتر',
        clearFilters: 'إزالة الفلاتر',
        searchHistory: 'تصفية حسب المنتج أو النوع...',
        addProductTitle: 'إضافة منتج',
        editProductTitle: 'تعديل المنتج',
        productName: 'اسم المنتج *',
        brandName: 'العلامة التجارية *',
        productCode: 'رمز المنتج',
        marginCalculated: 'الهامش (محسوب)',
        stockQuantity: 'كمية المخزون',
        notes: 'ملاحظات',
        save: 'حفظ',
        cancel: 'إلغاء',
        noProducts: 'لا توجد منتجات',
        noSales: 'لا توجد مبيعات بعد',
        saleSuccess: 'تم تسجيل البيع! الهامش: ',
        undoSuccess: 'تم إلغاء البيع!',
        saveSuccess: 'تم حفظ المنتج بنجاح!',
        deleteSuccess: 'تم حذف المنتج بنجاح!',
        exportSuccess: 'تم تصدير البيانات بنجاح!',
        importSuccess: 'تم استيراد البيانات بنجاح!',
        deleteConfirm: 'هل أنت متأكد من حذف هذا المنتج؟',
        importConfirm: 'سيؤدي هذا إلى استبدال جميع المنتجات الحالية. متابعة؟',
        stockError: 'مخزون غير كافٍ!',
        noSaleToUndo: 'لا توجد عملية بيع حديثة للتراجع عنها لهذا المنتج!',
        resetConfirm: 'تصفير الهامش المحقق؟ سيبقى السجل محفوظاً.',
        resetSuccess: 'تم تصفير الهامش.'
      }
    };

    // File System Access API storage (stores everything in pharma-data.json in selected folder)
    const FileStore = {
      supported: 'showDirectoryPicker' in window,
      async selectFolder() {
        const handle = await window.showDirectoryPicker();
        dirHandle = handle;
        useFileStore = true;
      },
      async getFileHandle() {
        if (!dirHandle) throw new Error('No folder selected');
        return await dirHandle.getFileHandle('pharma-data.json', { create: true });
      },
      async save(text) {
        const fileHandle = await this.getFileHandle();
        const writable = await fileHandle.createWritable();
        await writable.write(text);
        await writable.close();
      },
      async load() {
        const fileHandle = await this.getFileHandle();
        const file = await fileHandle.getFile();
        return await file.text();
      }
    };

    async function migrateFromLocalStorageIfNeeded() {
      try {
        localStorage.removeItem('pharmaProducts');
        localStorage.removeItem('pharmaSales');
        localStorage.removeItem('pharmaMarginOffset');
      } catch (e) {}
    }

    function t(key) {
      return translations[language][key] || key;
    }

    function applyTranslations() {
      document.querySelectorAll('[data-translate]').forEach(el => {
        const key = el.getAttribute('data-translate');
        el.textContent = t(key);
      });
      
      document.querySelectorAll('[data-translate-placeholder]').forEach(el => {
        const key = el.getAttribute('data-translate-placeholder');
        el.placeholder = t(key);
      });

      document.documentElement.setAttribute('dir', language === 'ar' ? 'rtl' : 'ltr');
      document.documentElement.setAttribute('lang', language);
    }

    function changeLanguage() {
      language = document.getElementById('langSelect').value;
      localStorage.setItem('lang', language);
      applyTranslations();
      renderAll();
    }

    function packState() {
      return JSON.stringify({
        v: 2,
        p: products.map(p => ({ i: p.id, n: p.name, b: p.brand, c: p.code, bp: p.purchasePrice, sp: p.salePrice, m: p.margin, q: p.quantity, no: p.notes })),
        s: sales.map(s => [s.date, s.productId, s.margin, s.type === 'undo' ? 'u' : 's']),
        o: marginOffset
      });
    }

    function unpackState(text) {
      const data = JSON.parse(text);
      if (data.v === 2) {
        products = Array.isArray(data.p) ? data.p.map(p => ({
          id: p.i,
          name: p.n,
          brand: p.b,
          code: p.c,
          purchasePrice: p.bp,
          salePrice: p.sp,
          margin: p.m,
          quantity: p.q,
          notes: p.no || ''
        })) : [];
        sales = Array.isArray(data.s) ? data.s.map(s => ({
          date: s[0],
          productId: s[1],
          margin: s[2],
          type: s[3] === 'u' ? 'undo' : 'sale',
          productName: ''
        })) : [];
        marginOffset = parseFloat(data.o || 0) || 0;
      } else {
        // backward compatibility
        products = Array.isArray(data.products) ? data.products : [];
        sales = Array.isArray(data.sales) ? data.sales : [];
        marginOffset = parseFloat(data.marginOffset || 0) || 0;
      }
      // reattach product names for rendering
      const names = new Map(products.map(p => [p.id, p.name]));
      sales = sales.map(s => ({ ...s, productName: s.productName || names.get(s.productId) || '(deleted)' }));
    }

    async function loadProducts() {
      if (useFileStore && FileStore.supported && dirHandle) {
        try {
          const txt = await FileStore.load();
          unpackState(txt);
          renderAll();
          return;
        } catch (e) { showAlert('Erreur de lecture fichier: ' + e.message, 'error'); }
      }
      // File storage is mandatory; if no folder selected, show empty state
      products = [];
      sales = [];
      marginOffset = 0;
      renderAll();
    }

    async function saveAll() {
      if (!useFileStore || !dirHandle) {
        showAlert('Dossier non sélectionné. Les données ne seront pas sauvegardées.', 'error');
        return;
      }
      const payload = packState();
      try { await FileStore.save(payload); }
      catch (e) { showAlert('Erreur sauvegarde fichier: ' + e.message, 'error'); }
    }

    function saveProducts() { saveAll().then(renderAll); }
    function saveSales() { saveAll(); }

    function renderDashboard() {
      const total = products.length;
      const value = products.reduce((s, p) => s + (parseFloat(p.salePrice || 0) * parseFloat(p.quantity || 0)), 0);
      const marginRaw = sales.reduce((s, sale) => s + parseFloat(sale.margin || 0), 0);
      const margin = marginRaw - marginOffset;
      
      document.getElementById('totalProducts').textContent = total;
      document.getElementById('totalValue').textContent = value.toFixed(2) + '€';
      document.getElementById('totalMargin').textContent = margin.toFixed(2) + '€';
      
      const recent = products.slice(-5).reverse();
      document.getElementById('recentProducts').innerHTML = recent.length ? recent.map(p => `
        <tr><td>${p.name}</td><td>${p.brand}</td><td>${parseFloat(p.salePrice || 0).toFixed(2)}€</td>
        <td class="${parseFloat(p.margin || 0) < 0 ? 'margin-negative' : ''}">${parseFloat(p.margin || 0).toFixed(2)}€</td>
        <td>${p.quantity || 0}</td></tr>
      `).join('') : `<tr><td colspan="5" style="text-align: center; color: #999;">${t('noProducts')}</td></tr>`;
    }

    function getFilteredSales() {
      const startEl = document.getElementById('historyStart');
      const endEl = document.getElementById('historyEnd');
      const searchEl = document.getElementById('historySearch');
      const start = startEl && startEl.value ? new Date(startEl.value) : null;
      const end = endEl && endEl.value ? new Date(endEl.value) : null;
      const term = (searchEl && searchEl.value ? searchEl.value : '').toString().toLowerCase();

      return sales.filter(sale => {
        const d = new Date(sale.date);
        if (start && d < new Date(start.getTime())) return false;
        if (end) {
          const endDay = new Date(end);
          endDay.setHours(23,59,59,999);
          if (d > endDay) return false;
        }
        const name = (sale.productName || '').toString().toLowerCase();
        const type = (sale.type || 'sale').toString().toLowerCase();
        return name.includes(term) || type.includes(term);
      }).sort((a, b) => new Date(b.date) - new Date(a.date));
    }

    function renderHistory() {
      const list = getFilteredSales();
      document.getElementById('historyList').innerHTML = list.length ? list.map(sale => {
        const date = new Date(sale.date);
        const formatted = `${date.toLocaleDateString()} ${date.toLocaleTimeString()}`;
        const marginVal = parseFloat(sale.margin || 0);
        const typeLabel = sale.type === 'undo' ? t('undoType') : t('sale');
        const qty = sale.type === 'undo' ? '+1' : '-1';
        const marginClass = marginVal < 0 ? 'margin-negative' : '';
        return `<tr><td>${formatted}</td><td>${sale.productName}</td><td class="${marginClass}">${marginVal.toFixed(2)}€</td><td>${qty}</td><td>${typeLabel}</td></tr>`;
      }).join('') : `<tr><td colspan="5" style="text-align: center; color: #999;">${t('noSales')}</td></tr>`;
    }

    function applyHistoryFilters() { renderHistory(); }
    function clearHistoryFilters() {
      const startEl = document.getElementById('historyStart');
      const endEl = document.getElementById('historyEnd');
      const searchEl = document.getElementById('historySearch');
      if (startEl) startEl.value = '';
      if (endEl) endEl.value = '';
      if (searchEl) searchEl.value = '';
      renderHistory();
    }

    function renderProducts() {
      const searchEl = document.getElementById('searchInput');
      const search = (searchEl && searchEl.value ? searchEl.value : '').toString().toLowerCase();
      const filtered = products.filter(p => {
        const name = (p && p.name ? p.name : '').toString().toLowerCase();
        const brand = (p && p.brand ? p.brand : '').toString().toLowerCase();
        const code = (p && p.code ? p.code : '').toString().toLowerCase();
        return name.includes(search) || brand.includes(search) || code.includes(search);
      });
      
      document.getElementById('productsList').innerHTML = filtered.length ? filtered.map(p => {
        const lastSale = sales.filter(s => s.productId === p.id).pop();
        return `
        <tr><td>${p.name}</td><td>${p.brand}</td><td>${parseFloat(p.purchasePrice || 0).toFixed(2)}€</td>
        <td>${parseFloat(p.salePrice || 0).toFixed(2)}€</td>
        <td class="${parseFloat(p.margin || 0) < 0 ? 'margin-negative' : ''}">${parseFloat(p.margin || 0).toFixed(2)}€</td>
        <td>${p.quantity || 0}</td>
        <td class="actions">
          <button class="sale-btn" onclick="sellProduct(${p.id})" ${p.quantity <= 0 ? 'disabled' : ''}>${t('sell')}</button>
          <button class="undo-btn" onclick="undoSale(${p.id})" ${!lastSale ? 'disabled' : ''}>${t('undo')}</button>
          <button class="btn btn-secondary" onclick="editProduct(${p.id})">${t('edit')}</button>
          <button class="btn btn-danger" onclick="deleteProduct(${p.id})">${t('delete')}</button>
        </td></tr>
      `}).join('') : `<tr><td colspan="7" style="text-align: center; color: #999;">${t('noProducts')}</td></tr>`;
    }

    function renderAll() { 
      renderDashboard(); 
      renderProducts();
      renderHistory();
      applyTranslations();
    }

    function sellProduct(id) {
      const product = products.find(p => p.id === id);
      if (!product || product.quantity <= 0) return showAlert(t('stockError'), 'error');
      
      product.quantity--;
      const sale = {
        id: Date.now(),
        productId: id,
        productName: product.name,
        margin: parseFloat(product.margin || 0),
        date: new Date().toISOString(),
        type: 'sale'
      };
      sales.push(sale);
      
      saveProducts();
      saveSales();
      showAlert(t('saleSuccess') + product.margin + '€', 'success');
    }

    function undoSale(id) {
      const product = products.find(p => p.id === id);
      if (!product) return;
      
      const lastSaleIndex = sales.map((s, i) => s.productId === id && s.type === 'sale' ? i : -1).filter(i => i !== -1).pop();
      if (lastSaleIndex === undefined) {
        return showAlert(t('noSaleToUndo'), 'error');
      }
      
      const lastSale = sales[lastSaleIndex];
      product.quantity++;
      // Keep original sale in history; add undo entry with negative margin so totals reflect reversal.
      sales.push({
        id: Date.now(),
        productId: id,
        productName: product.name,
        margin: -Math.abs(parseFloat(lastSale.margin || 0)),
        date: new Date().toISOString(),
        type: 'undo'
      });
      
      saveProducts();
      saveSales();
      showAlert(t('undoSuccess'), 'success');
    }

    function resetMargin() {
      if (!confirm(t('resetConfirm'))) return;
      const totalMargin = sales.reduce((s, sale) => s + parseFloat(sale.margin || 0), 0);
      marginOffset = totalMargin;
      saveAll().then(() => renderAll());
      showAlert(t('resetSuccess'), 'success');
    }

    function exportHistoryPDF() {
      const list = getFilteredSales();
      const totalRawMargin = list.reduce((s, sale) => s + parseFloat(sale.margin || 0), 0);
      const startEl = document.getElementById('historyStart');
      const endEl = document.getElementById('historyEnd');
      const rangeText = `${startEl && startEl.value ? startEl.value : '...'} → ${endEl && endEl.value ? endEl.value : '...'}`;

      const rows = list.map(sale => {
        const d = new Date(sale.date);
        const formatted = `${d.toLocaleDateString()} ${d.toLocaleTimeString()}`;
        const marginVal = parseFloat(sale.margin || 0);
        const typeLabel = sale.type === 'undo' ? t('undoType') : t('sale');
        const qty = sale.type === 'undo' ? '+1' : '-1';
        const marginTxt = `${marginVal.toFixed(2)}€`;
        return `<tr><td>${formatted}</td><td>${sale.productName}</td><td>${qty}</td><td>${typeLabel}</td><td>${marginTxt}</td></tr>`;
      }).join('');

      const html = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>History PDF</title>
        <style>
          body { font-family: Arial, sans-serif; padding: 20px; }
          h2 { margin-bottom: 0.2rem; }
          p { margin: 0.1rem 0 1rem 0; }
          table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
          th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
          th { background: #f5f5f5; }
        </style>
      </head><body>
        <h2>${t('historyTitle')}</h2>
        <p>${t('saleDate')}: ${rangeText}</p>
        <p>${t('saleMargin')}: ${totalRawMargin.toFixed(2)}€</p>
        <table>
          <thead><tr><th>${t('saleDate')}</th><th>${t('saleProduct')}</th><th>${t('saleQuantity')}</th><th>${t('saleType')}</th><th>${t('saleMargin')}</th></tr></thead>
          <tbody>${rows || `<tr><td colspan="5">${t('noSales')}</td></tr>`}</tbody>
        </table>
      </body></html>`;

      // Reuse file save when a data folder is selected; otherwise open print window.
      if (useFileStore && FileStore.supported && dirHandle && dirHandle.name) {
        const blob = new Blob([html], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `history-${new Date().toISOString().split('T')[0]}.html`;
        a.click();
        URL.revokeObjectURL(url);
      } else {
        const win = window.open('', '_blank');
        win.document.write(html);
        win.document.close();
        win.focus();
        win.print();
      }
    }

    function openAddForm() {
      currentEditId = null;
      document.getElementById('formTitle').textContent = t('addProductTitle');
      document.getElementById('productForm').reset();
      document.getElementById('formModal').classList.add('active');
    }

    function editProduct(id) {
      const product = products.find(p => p.id === id);
      if (!product) return;
      
      currentEditId = id;
      document.getElementById('formTitle').textContent = t('editProductTitle');
      document.getElementById('formName').value = product.name;
      document.getElementById('formBrand').value = product.brand;
      document.getElementById('formCode').value = product.code || '';
      document.getElementById('formPurchasePrice').value = product.purchasePrice || '';
      document.getElementById('formSalePrice').value = product.salePrice || '';
      document.getElementById('formMargin').value = product.margin || '';
      document.getElementById('formQuantity').value = product.quantity || '';
      document.getElementById('formNotes').value = product.notes || '';
      document.getElementById('formModal').classList.add('active');
    }

    function deleteProduct(id) {
      if (!confirm(t('deleteConfirm'))) return;
      products = products.filter(p => p.id !== id);
      saveProducts();
      showAlert(t('deleteSuccess'), 'success');
    }

    function saveProduct(event) {
      event.preventDefault();
      const name = document.getElementById('formName').value.trim();
      const brand = document.getElementById('formBrand').value.trim();
      if (!name || !brand) {
        const msg = language === 'ar' ? 'يرجى إدخال الاسم والعلامة التجارية' : 'Please enter name and brand';
        return showAlert(msg, 'error');
      }

      const purchase = parseFloat(document.getElementById('formPurchasePrice').value || 0);
      const sale = parseFloat(document.getElementById('formSalePrice').value || 0);
      const marginInput = document.getElementById('formMargin').value;
      const computedMargin = marginInput === '' ? (sale - purchase).toFixed(2) : marginInput;

      const product = {
        id: currentEditId || Date.now(),
        name,
        brand,
        code: document.getElementById('formCode').value,
        purchasePrice: purchase,
        salePrice: sale,
        margin: parseFloat(computedMargin || 0),
        quantity: parseInt(document.getElementById('formQuantity').value || 0),
        notes: document.getElementById('formNotes').value
      };
      
      if (currentEditId) {
        const index = products.findIndex(p => p.id === currentEditId);
        products[index] = product;
      } else {
        products.push(product);
      }
      
      saveProducts();
      closeForm();
      showAlert(t('saveSuccess'), 'success');
    }

    function calculateMargin() {
      const purchase = parseFloat(document.getElementById('formPurchasePrice').value || 0);
      const sale = parseFloat(document.getElementById('formSalePrice').value || 0);
      document.getElementById('formMargin').value = (sale - purchase).toFixed(2);
    }

    function closeForm() {
      document.getElementById('formModal').classList.remove('active');
    }

    function filterProducts() {
      renderProducts();
    }

    function exportData() {
      const data = packState();
      const blob = new Blob([data], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `pharma-db-${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      URL.revokeObjectURL(url);
      showAlert(t('exportSuccess'), 'success');
    }

    function handleImport() {
      const file = document.getElementById('importFile').files[0];
      if (!file) return;
      
      if (!confirm(t('importConfirm'))) {
        document.getElementById('importFile').value = '';
        return;
      }
      
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          unpackState(e.target.result);
          saveAll();
          renderAll();
          showAlert(t('importSuccess'), 'success');
          document.getElementById('importFile').value = '';
        } catch (error) {
          showAlert('Error: ' + error.message, 'error');
        }
      };
      reader.readAsText(file);
    }

    function showAlert(message, type) {
      const alert = document.getElementById('alert');
      alert.textContent = message;
      alert.className = `alert show alert-${type}`;
      setTimeout(() => alert.classList.remove('show'), 3000);
    }

    async function selectDataFile() {
      if (!FileStore.supported) return showAlert('File System Access non supporté par ce navigateur', 'error');
      try {
        await FileStore.selectFolder();
        const txt = await FileStore.load();
        unpackState(txt);
        renderAll();
        updateFileStatus();
        showAlert('Dossier sélectionné, données chargées', 'success');
      } catch (e) { 
        if (e.name !== 'AbortError') showAlert('Erreur: ' + e.message, 'error');
      }
    }

    async function createDataFile() {
      if (!FileStore.supported) return showAlert('File System Access non supporté par ce navigateur', 'error');
      try {
        await FileStore.selectFolder();
        await saveAll();
        updateFileStatus();
        showAlert('Dossier sélectionné, fichier créé', 'success');
      } catch (e) { 
        if (e.name !== 'AbortError') showAlert('Erreur: ' + e.message, 'error');
      }
    }

    function updateFileStatus() {
      const el = document.getElementById('fileStatus');
      if (!el) return;
      if (useFileStore && dirHandle && dirHandle.name) {
        el.textContent = `Dossier: ${dirHandle.name}`;
      } else {
        el.textContent = 'Aucun dossier sélectionné';
      }
    }

    function changePage(page, button) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById(page).classList.add('active');
      document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
      button.classList.add('active');
    }

    window.addEventListener('DOMContentLoaded', () => {
      (async () => {
        await migrateFromLocalStorageIfNeeded();
        if (FileStore.supported) {
          const needsFolder = confirm('Sélectionner un dossier pour stocker les données ? (obligatoire)');
          if (needsFolder) {
            try { await selectDataFile(); } catch (e) {}
          }
        }
        document.getElementById('langSelect').value = language;
        applyTranslations();
        await loadProducts();
        updateFileStatus();
      })();
    });
  </script>
</body>
</html>
